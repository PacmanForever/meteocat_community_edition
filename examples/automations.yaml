# ==============================================================================
# EXEMPLES D'AUTOMATITZACIONS - Meteocat (Community Edition)
# ==============================================================================
#
# Aquest fitxer cont√© exemples pr√†ctics d'automatitzacions per utilitzar
# la integraci√≥ Meteocat amb Home Assistant.
#
# NOTA: Canvia els noms d'entitats per adaptar-los a la teva configuraci√≥!
#
# ==============================================================================

# ------------------------------------------------------------------------------
# 1. NOTIFICACIONS BASADES EN ESDEVENIMENTS
# ------------------------------------------------------------------------------

# Notificaci√≥ quan hi ha noves dades disponibles
- alias: "Meteocat - Notificaci√≥ actualitzaci√≥ dades"
  description: "Envia notificaci√≥ cada cop que s'actualitzen les dades de Meteocat"
  trigger:
    - platform: event
      event_type: meteocat_community_edition_data_updated
  action:
    - service: notify.mobile_app
      data:
        title: "‚òÅÔ∏è Meteocat actualitzat"
        message: >
          Noves dades meteorol√≤giques disponibles.
          Mode: {{ trigger.event.data.mode }}
          Timestamp: {{ trigger.event.data.timestamp }}

# Notificaci√≥ nom√©s per una estaci√≥ espec√≠fica
- alias: "Meteocat - Notificaci√≥ estaci√≥ Granollers"
  description: "Notifica nom√©s quan s'actualitza l'estaci√≥ de Granollers"
  trigger:
    - platform: event
      event_type: meteocat_community_edition_data_updated
      event_data:
        mode: estacio
        station_code: YM  # Canvia pel codi de la teva estaci√≥
  action:
    - service: notify.mobile_app
      data:
        title: "üå°Ô∏è Estaci√≥ Granollers actualitzada"
        message: "Noves dades de l'estaci√≥ meteorol√≤gica de Granollers!"

# Notificaci√≥ nom√©s per un municipi espec√≠fic
- alias: "Meteocat - Notificaci√≥ municipi Granollers"
  description: "Notifica nom√©s quan s'actualitza el municipi de Granollers"
  trigger:
    - platform: event
      event_type: meteocat_community_edition_data_updated
      event_data:
        mode: municipi
        municipality_code: "080759"  # Canvia pel codi del teu municipi
  action:
    - service: notify.mobile_app
      data:
        title: "üèôÔ∏è Prediccions Granollers"
        message: "Noves prediccions municipals disponibles!"

# ------------------------------------------------------------------------------
# 2. ALERTES METEOROL√íGIQUES BASADES EN PREDICCIONS
# ------------------------------------------------------------------------------

# Av√≠s de temperatura alta dem√† (Mode Municipal)
- alias: "Meteocat - Av√≠s temperatura alta dem√†"
  description: "Notifica a les 20h si dem√† far√† m√©s de 30¬∞C"
  trigger:
    - platform: time
      at: "20:00:00"
  condition:
    - condition: template
      value_template: >
        {% set forecast = state_attr('sensor.granollers_prediccio_diaria', 'forecast') %}
        {% if forecast and forecast.dies | length > 1 %}
          {{ forecast.dies[1].variables.tmax.valor | float > 30 }}
        {% else %}
          false
        {% endif %}
  action:
    - service: notify.mobile_app
      data:
        title: "üî• Temperatura alta dem√†"
        message: >
          {% set forecast = state_attr('sensor.granollers_prediccio_diaria', 'forecast') %}
          Dem√† es preveuen {{ forecast.dies[1].variables.tmax.valor }}¬∞C.
          Porta't aigua i protector solar!

# Av√≠s de temperatura baixa dem√† (Mode Municipal)
- alias: "Meteocat - Av√≠s temperatura baixa dem√†"
  description: "Notifica a les 20h si dem√† far√† menys de 5¬∞C"
  trigger:
    - platform: time
      at: "20:00:00"
  condition:
    - condition: template
      value_template: >
        {% set forecast = state_attr('sensor.granollers_prediccio_diaria', 'forecast') %}
        {% if forecast and forecast.dies | length > 1 %}
          {{ forecast.dies[1].variables.tmin.valor | float < 5 }}
        {% else %}
          false
        {% endif %}
  action:
    - service: notify.mobile_app
      data:
        title: "‚ùÑÔ∏è Temperatura baixa dem√†"
        message: >
          {% set forecast = state_attr('sensor.granollers_prediccio_diaria', 'forecast') %}
          Dem√† es preveuen {{ forecast.dies[1].variables.tmin.valor }}¬∞C de m√≠nima.
          Abriga't b√©!

# Av√≠s de pluja prevista avui
- alias: "Meteocat - Av√≠s pluja avui"
  description: "Notifica al mat√≠ si avui plour√†"
  trigger:
    - platform: time
      at: "07:00:00"
  condition:
    - condition: template
      value_template: >
        {% set forecast = state_attr('sensor.granollers_prediccio_diaria', 'forecast') %}
        {% if forecast and forecast.dies | length > 0 %}
          {{ forecast.dies[0].variables.ppcp.valor | default(0) | float > 0 }}
        {% else %}
          false
        {% endif %}
  action:
    - service: notify.mobile_app
      data:
        title: "‚òî Pluja prevista avui"
        message: >
          {% set forecast = state_attr('sensor.granollers_prediccio_diaria', 'forecast') %}
          Es preveuen {{ forecast.dies[0].variables.ppcp.valor }}mm de pluja.
          Porta't el paraigua!

# ------------------------------------------------------------------------------
# 3. AUTOMATITZACIONS INTEL¬∑LIGENTS DE CASA
# ------------------------------------------------------------------------------

# Tancar persianes si far√† molta calor dem√†
- alias: "Meteocat - Tancar persianes si calor dem√†"
  description: "Tanca persianes a les 7h si dem√† far√† m√©s de 32¬∞C"
  trigger:
    - platform: time
      at: "07:00:00"
  condition:
    - condition: template
      value_template: >
        {% set forecast = state_attr('sensor.granollers_prediccio_diaria', 'forecast') %}
        {% if forecast and forecast.dies | length > 0 %}
          {{ forecast.dies[0].variables.tmax.valor | float > 32 }}
        {% else %}
          false
        {% endif %}
  action:
    - service: cover.close_cover
      target:
        entity_id: cover.persiana_sal√≥  # Canvia per les teves persianes
    - service: notify.mobile_app
      data:
        message: "Persianes tancades autom√†ticament. Avui far√† molta calor!"

# Activar reg si no ha plogut
- alias: "Meteocat - Reg autom√†tic si no plou"
  description: "Activa el reg si ahir no va ploure"
  trigger:
    - platform: time
      at: "06:30:00"
  condition:
    - condition: template
      value_template: >
        {% set forecast = state_attr('sensor.granollers_prediccio_diaria', 'forecast') %}
        {% if forecast and forecast.dies | length > 0 %}
          {{ forecast.dies[0].variables.ppcp.valor | default(0) | float == 0 }}
        {% else %}
          true
        {% endif %}
  action:
    - service: switch.turn_on
      target:
        entity_id: switch.reg_jard√≠  # Canvia per la teva entitat de reg
    - delay:
        minutes: 15
    - service: switch.turn_off
      target:
        entity_id: switch.reg_jard√≠

# Escalfar casa si far√† fred al vespre
- alias: "Meteocat - Pre-escalfar casa"
  description: "Escalfa la casa si a la nit far√† menys de 12¬∞C"
  trigger:
    - platform: time
      at: "18:00:00"
  condition:
    - condition: template
      value_template: >
        {% set forecast = state_attr('sensor.granollers_prediccio_horaria', 'forecast') %}
        {% if forecast and forecast.dies | length > 0 %}
          {% set temp_22h = forecast.dies[0].variables.temp.valors[22] | default(15) %}
          {{ temp_22h | float < 12 }}
        {% else %}
          false
        {% endif %}
  action:
    - service: climate.set_temperature
      target:
        entity_id: climate.term√≤stat_sal√≥  # Canvia per la teva entitat
      data:
        temperature: 21

# ------------------------------------------------------------------------------
# 4. GESTI√ì DE QUOTES API
# ------------------------------------------------------------------------------

# Av√≠s de quotes baixes (menys del 20%)
- alias: "Meteocat - Av√≠s quotes baixes"
  description: "Notifica quan queden menys del 20% de quotes disponibles"
  trigger:
    - platform: numeric_state
      entity_id:
        - sensor.granollers_ym_quota_prediccio
        - sensor.granollers_ym_quota_xema
      below: 200  # Ajusta segons el teu pla (20% de 1000 = 200)
  action:
    - service: notify.mobile_app
      data:
        title: "‚ö†Ô∏è Quotes Meteocat baixes"
        message: >
          Queden poques peticions disponibles:
          Predicci√≥: {{ states('sensor.granollers_ym_quota_prediccio') }}
          XEMA: {{ states('sensor.granollers_ym_quota_xema') }}

# Notificaci√≥ quan es resetegin les quotes
- alias: "Meteocat - Notificaci√≥ reset quotes"
  description: "Informa quan es resetegin les quotes mensuals"
  trigger:
    - platform: state
      entity_id: sensor.granollers_ym_quota_prediccio
  condition:
    - condition: template
      value_template: >
        {{ trigger.to_state.state | int > trigger.from_state.state | int + 500 }}
  action:
    - service: notify.mobile_app
      data:
        title: "üîÑ Quotes Meteocat resetejades"
        message: >
          Les quotes mensuals s'han resetejat.
          Disponibles: {{ states('sensor.granollers_ym_quota_prediccio') }}

# ------------------------------------------------------------------------------
# 5. ACTUALITZACIONS MANUALS INTEL¬∑LIGENTS
# ------------------------------------------------------------------------------

# Actualitzaci√≥ manual abans de sortir de casa
- alias: "Meteocat - Actualitzar abans de sortir"
  description: "Actualitza dades quan obris la porta al mat√≠"
  trigger:
    - platform: state
      entity_id: binary_sensor.porta_entrada  # Canvia per la teva entitat
      to: "on"
  condition:
    - condition: time
      after: "06:00:00"
      before: "10:00:00"
    - condition: template
      value_template: >
        {{ (now() - states.sensor.granollers_ym_last_update.last_changed).total_seconds() > 3600 }}
  action:
    - service: button.press
      target:
        entity_id: button.granollers_ym_refresh

# Actualitzaci√≥ manual si fa m√©s d'una hora que no s'ha actualitzat
- alias: "Meteocat - Actualitzaci√≥ d'emerg√®ncia"
  description: "For√ßa actualitzaci√≥ si fa m√©s de 6 hores sense actualitzar"
  trigger:
    - platform: time_pattern
      hours: "/1"  # Comprova cada hora
  condition:
    - condition: template
      value_template: >
        {{ (now() - states.sensor.granollers_ym_last_update.last_changed).total_seconds() > 21600 }}
  action:
    - service: button.press
      target:
        entity_id: button.granollers_ym_refresh
    - service: notify.mobile_app
      data:
        title: "‚ö†Ô∏è Actualitzaci√≥ Meteocat for√ßada"
        message: "Feia m√©s de 6 hores sense actualitzar. Actualitzaci√≥ for√ßada."

# ------------------------------------------------------------------------------
# 6. AUTOMATITZACIONS BASADES EN TIMESTAMPS
# ------------------------------------------------------------------------------

# Notificaci√≥ 5 minuts abans de l'actualitzaci√≥ programada
- alias: "Meteocat - Recordatori actualitzaci√≥ propera"
  description: "Avisa 5 minuts abans de l'actualitzaci√≥ programada"
  trigger:
    - platform: template
      value_template: >
        {{ (as_timestamp(states('sensor.granollers_ym_next_update')) - now().timestamp()) < 300 and
           (as_timestamp(states('sensor.granollers_ym_next_update')) - now().timestamp()) > 0 }}
  action:
    - service: notify.mobile_app
      data:
        title: "üïê Actualitzaci√≥ Meteocat en 5 minuts"
        message: >
          Pr√≤xima actualitzaci√≥ a les {{ states('sensor.granollers_ym_next_update') | as_timestamp | timestamp_custom('%H:%M') }}

# Registrar al logbook cada actualitzaci√≥
- alias: "Meteocat - Log actualitzacions"
  description: "Registra cada actualitzaci√≥ al logbook de Home Assistant"
  trigger:
    - platform: event
      event_type: meteocat_community_edition_data_updated
  action:
    - service: logbook.log
      data:
        name: "Meteocat"
        message: >
          Actualitzaci√≥ completada:
          Mode: {{ trigger.event.data.mode }}
          {% if trigger.event.data.station_code %}
          Estaci√≥: {{ trigger.event.data.station_code }}
          {% endif %}
          {% if trigger.event.data.municipality_code %}
          Municipi: {{ trigger.event.data.municipality_code }}
          {% endif %}
          Hora: {{ trigger.event.data.timestamp }}

# ------------------------------------------------------------------------------
# 7. INTEGRACIONS AMB ALTRES SERVEIS
# ------------------------------------------------------------------------------

# Actualitzar dashboard de Lovelace despr√©s d'actualitzaci√≥
- alias: "Meteocat - Refresh dashboard"
  description: "Actualitza el dashboard meteorol√≤gic despr√©s de cada actualitzaci√≥"
  trigger:
    - platform: event
      event_type: meteocat_community_edition_data_updated
  action:
    - service: browser_mod.navigate
      data:
        path: /lovelace/meteo  # Canvia per la teva vista
    - delay:
        seconds: 1
    - service: browser_mod.navigate
      data:
        path: /lovelace/0

# Enviar dades a InfluxDB per hist√≤ric
- alias: "Meteocat - Export to InfluxDB"
  description: "Exporta dades a InfluxDB per an√†lisi hist√≤rica"
  trigger:
    - platform: event
      event_type: meteocat_community_edition_data_updated
  action:
    - service: script.export_meteocat_to_influxdb  # Defineix el teu script

# Publicar a MQTT per integraci√≥ amb Node-RED
- alias: "Meteocat - Publish to MQTT"
  description: "Publica actualitzacions a MQTT"
  trigger:
    - platform: event
      event_type: meteocat_community_edition_data_updated
  action:
    - service: mqtt.publish
      data:
        topic: "home/meteocat/update"
        payload: >
          {
            "mode": "{{ trigger.event.data.mode }}",
            "timestamp": "{{ trigger.event.data.timestamp }}",
            "station_code": "{{ trigger.event.data.station_code | default('') }}",
            "municipality_code": "{{ trigger.event.data.municipality_code | default('') }}"
          }

# ==============================================================================
# FI D'EXEMPLES
# ==============================================================================
#
# Per m√©s informaci√≥ i exemples avan√ßats:
# https://github.com/PacmanForever/meteocat_community_edition
#
# ==============================================================================
